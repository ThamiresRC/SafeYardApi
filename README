# SafeYardApi

API em **Spring Boot** para controle de entrada/saÃ­da de **motos em pÃ¡tios** (yard), com autenticaÃ§Ã£o **JWT**, documentaÃ§Ã£o **OpenAPI/Swagger**, **migrations Flyway**, paginaÃ§Ã£o/ordenaÃ§Ã£o/filtros, seed inicial e **interfaces web (Thymeleaf)** para Cliente/Admin.

## ğŸ¯ Objetivo do Projeto (adequado ao Java)
O **SafeYard** Ã© uma aplicaÃ§Ã£o Java (Spring Boot) desenvolvida tomando como cenÃ¡rio a **Mottu**, com o objetivo de **modernizar e otimizar a gestÃ£o de pÃ¡tios de motos**. A soluÃ§Ã£o oferece:
- **Camada REST** para operaÃ§Ãµes de cadastro/consulta (**motos, clientes, locaÃ§Ãµes e registros**) com **JWT**;
- **Interface web (Thymeleaf)** para que **Administradores** gerenciem a frota e as **locaÃ§Ãµes** (checkâ€‘in/out) e **Clientes** solicitem e acompanhem suas locaÃ§Ãµes;
- **Regras de negÃ³cio** para **evitar erros manuais** (ex.: impedir dupla locaÃ§Ã£o da mesma moto, aceitar apenas motos `DISPONIVEL`, registrar encerramento);
- **Rastreabilidade** via banco de dados com **Flyway** e **seeds** reproducÃ­veis; acesso a **H2 Console** para verificaÃ§Ã£o durante a banca.

**Resultados esperados:** maior controle operacional, reduÃ§Ã£o de inconsistÃªncias e **experiÃªncia simples** para o usuÃ¡rio, demonstrados por fluxos completos de **login â†’ locaÃ§Ã£o â†’ encerramento â†’ consultas/relatÃ³rios**.

**Metas demonstrÃ¡veis na banca:**
- (1) Criar uma locaÃ§Ã£o **sem permitir conflitos** (mesma moto jÃ¡ locada).
- (2) **Encerrar** a locaÃ§Ã£o atualizando automaticamente o **status da moto**.
- (3) Exibir, para o cliente, **histÃ³rico de locaÃ§Ãµes** e, para o admin, **visÃ£o da frota**.
- (4) Mostrar **documentaÃ§Ã£o** no Swagger e **validaÃ§Ã£o JWT** funcionando.


> **Sprint 3 â€“ pronto para avaliaÃ§Ã£o.** Este README contÃ©m tudo o que o professor pede (instalaÃ§Ã£o, execuÃ§Ã£o, acesso, endpoints, vÃ­deo-roteiro e notas para a avaliaÃ§Ã£o oral).

---

## ğŸ”§ Stack
- Java **21** Â· Spring Boot **3.x** (Web, Validation, JPA/Hibernate, Security)
- Auth: **JWT** (`com.auth0:java-jwt`)
- Banco: **H2** (dev) Â· opcional Postgres/MySQL (prod)
- MigraÃ§Ãµes: **Flyway** (`src/main/resources/db/migration`)
- Views: **Thymeleaf** (layouts + pÃ¡ginas para cliente e admin)
- Docs: **springdoc-openapi** (`/swagger-ui.html`)
- Build: **Maven**  
- DevOps: Dockerfile + script de deploy

---

## ğŸ—‚ï¸ DomÃ­nio (resumo)
- **Cliente** â€“ dados cadastrais (pode possuir motos)
- **Moto** â€“ placa, modelo, chassi, fotoUrl, status: `DISPONIVEL`, `LOCADA`, `MANUTENCAO`
- **Locacao** â€“ check-in/check-out da moto no pÃ¡tio (datas, condiÃ§Ãµes, cliente, moto)
- **RegistroMotoPatio** â€“ histÃ³rico de movimentaÃ§Ãµes (opcional/relatÃ³rios)
- **User**/**UserRole**/**Token** â€“ autenticaÃ§Ã£o/autorizaÃ§Ã£o via JWT

---

## ğŸ“ Estrutura de pacotes
```
src/main/java/com/safeyard/safeyard_api/
 â”œâ”€ config/        # CORS, Security, Swagger, Web + seed e init de storage
 â”œâ”€ controller/    # REST + Web (Thymeleaf) â€“ Auth, Cliente, Moto, Locacao, Registro
 â”œâ”€ dto/           # DTOs (Form, View e Responses de Auth)
 â”œâ”€ exception/     # Handler global e payload de erro
 â”œâ”€ model/         # Entidades JPA + enums
 â”œâ”€ repository/    # Spring Data JPA
 â”œâ”€ service/       # Regras de negÃ³cio + fachada de LocaÃ§Ã£o + Auth/JWT
 â””â”€ SafeyardApiApplication.java
```

MigraÃ§Ãµes em `resources/db.migration` (ex.: `V1__schema.sql`, Ã­ndices, seeds, regras de locaÃ§Ã£o, colunas, etc.).

---

## â–¶ï¸ Como executar (modo DEV)
1. **PrÃ©-requisitos**: JDK **21**, Maven, porta **8080** livre.  
2. **Clonar**: `git clone <repo>`
3. **Rodar**: `./mvnw spring-boot:run` (Linux/Mac) ou `mvnw spring-boot:run` (Windows)
4. Acesso:
   - Web (Thymeleaf): `http://localhost:8080/login`
   - Swagger: `http://localhost:8080/swagger-ui.html`
   - H2 Console: `http://localhost:8080/h2-console` (JDBC: `jdbc:h2:file:./data/safeyard`)

> **Dev profile**: `application-dev.properties` jÃ¡ configurado para H2 + Flyway. Na primeira execuÃ§Ã£o, as *migrations* criam schema/Ã­ndices/seeds.

---

## ğŸ” Contas de teste (seed)
- **Cliente**: `cliente@safeyard.com` Â· **123456**  
- **Admin**: `admin@safeyard.com` Â· **123456**  
- **FuncionÃ¡rio**: `func@safeyard.com` Â· **123456**

> Ao logar pela interface web, vocÃª verÃ¡ o **Dashboard** conforme o papel (cliente/admin) e poderÃ¡ navegar para **Minhas locaÃ§Ãµes**, **Motos**, **RelatÃ³rios** etc.

---

## ğŸ“˜ DocumentaÃ§Ã£o da API
- **Swagger/OpenAPI**: `http://localhost:8080/swagger-ui.html`
- **Esquema de seguranÃ§a**: Bearer **JWT**. Primeiro faÃ§a login no endpoint de Auth, copie o token e clique em **Authorize** no Swagger.

### Principais endpoints (REST)
**Auth**
- `POST /api/auth/login` â€“ body: `{ "email", "password" }` â†’ `LoginResponseDTO { token, name, role }`
- `POST /api/auth/register` *(opcional/ambiente de demo)*

**Motos** (ADMIN/FUNC Â· leitura CLIENTE)
- `GET /api/motos?page=&size=&sort=` â€“ paginaÃ§Ã£o/ordenaÃ§Ã£o
- `GET /api/motos/{id}`
- `POST /api/motos` â€“ cria moto (ADMIN/FUNC)
- `PUT /api/motos/{id}` Â· `DELETE /api/motos/{id}`

**LocaÃ§Ãµes** (CLIENTE e ADMIN)
- `GET /api/locacoes` â€“ pode aceitar filtros (p.ex. por perÃ­odo/status)
- `GET /api/locacoes/{id}`
- `POST /api/locacoes` â€“ cria locaÃ§Ã£o (valida moto **DISPONIVEL** e se nÃ£o hÃ¡ locaÃ§Ã£o ativa)
- `PUT /api/locacoes/{id}/encerrar` â€“ faz check-out/encerra

**Clientes** / **Registros**
- `GET /api/clientes` Â· `GET /api/clientes/{id}` â€¦
- `GET /api/registros` â€“ listagem/histÃ³rico

> Os controllers Web (Thymeleaf) expÃµem rotas como `/dashboard`, `/cliente/area`, `/motos`, `/locacao/*` para a experiÃªncia de navegaÃ§Ã£o via browser.

---

## ğŸ§ª Exemplos (curl)
**Login**
```bash
curl -X POST http://localhost:8080/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email":"cliente@safeyard.com","password":"123456"}'
```
**Listar motos (com Bearer)**
```bash
TOKEN=ey... # copie do login
curl -H "Authorization: Bearer $TOKEN" http://localhost:8080/api/motos
```
**Criar locaÃ§Ã£o**
```bash
curl -X POST http://localhost:8080/api/locacoes \
  -H "Authorization: Bearer $TOKEN" -H "Content-Type: application/json" \
  -d '{
    "motoId": 1,
    "clienteId": 1,
    "condicaoEntrega": "tanque cheio, sem avarias",
    "devolucaoPrevista": "2025-10-05T18:00:00"
  }'
```

---

## ğŸ§­ Roteiro para o **vÃ­deo (5â€“10 min)**
1. **Abertura (20s)** â€“ Nome do projeto, objetivo (controle de motos no pÃ¡tio) e stack.
2. **Rodando o app (40s)** â€“ `mvnw spring-boot:run`, mostrar logs do Flyway.
3. **Swagger (1min)** â€“ abrir `/swagger-ui.html`, login no `/api/auth/login`, usar **Authorize** com JWT.
4. **Motos (1min)** â€“ listar, abrir detalhe; se ADMIN, criar/editar via endpoint.
5. **LocaÃ§Ã£o (2â€“3min)** â€“ logar como **Cliente** (via web), criar **Nova locaÃ§Ã£o** (Thymeleaf) â†’ mostrar validaÃ§Ãµes (sÃ³ **DISPONIVEL**, sem locaÃ§Ã£o ativa). Encerrar locaÃ§Ã£o.
6. **Dashboards (1min)** â€“ logar como **Admin**, mostrar cards de **Clientes/Motos/RelatÃ³rios**.
7. **H2 Console (30s)** â€“ abrir `/h2-console`, JDBC `jdbc:h2:file:./data/safeyard`, ver tabelas.
8. **Encerramento (20s)** â€“ destacar JWT, camadas, migraÃ§Ãµes e o que faria a seguir (ex.: upload de imagens e S3).

> Dica: grave a tela em 1080p, fonte grande no navegador/IDE, e deixe o **README** aberto para guiar.

---

## ğŸ¤ Pontos para a **avaliaÃ§Ã£o oral**
- **Trechos do cÃ³digo**: `SecurityConfig` (filtro JWT + autorizaÃ§Ã£o), `AuthFilter` (extraÃ§Ã£o/validaÃ§Ã£o do token), `LocacaoService`/`LocacaoFacadeService` (regras de disponibilidade e encerramento), `GlobalExceptionHandler` (erros padronizados), `SwaggerConfig` (Bearer).
- **DecisÃµes**: usar DTOs para proteger entidades; `Facade` para orquestrar validaÃ§Ãµes de locaÃ§Ã£o; Ã­ndices/constraints via Flyway; H2 file-mode para persistir entre execuÃ§Ãµes.
- **Dificuldades**: regras de locaÃ§Ã£o sem conflitos; estados da moto; integraÃ§Ã£o Thymeleaf + Security; seeds coerentes.
- **IA no processo**: suporte para gerar/ajustar boilerplate (README, exemplos curl, roteiros); revisÃ£o de exceÃ§Ãµes e mensagens. **Validei tudo no cÃ³digo e testes manuais**.

---

## ğŸ³ Docker (opcional)
Build local (JDK 21 base):
```dockerfile
# (resumo) veja Dockerfile no projeto
FROM eclipse-temurin:21-jdk
WORKDIR /app
COPY . .
RUN sed -i 's/\r$//' mvnw && chmod +x mvnw
RUN ./mvnw -B -DskipTests clean package
EXPOSE 8080
CMD ["sh","-c","java -Dserver.port=${PORT:-8080} -Dspring.profiles.active=${SPRING_PROFILES_ACTIVE:-dev} -jar target/safeyard-api-*.jar"]
```
Build & run:
```bash
docker build -t safeyard-api .
docker run --rm -p 8080:8080 --name safeyard safeyard-api
```

---

## ğŸ” Troubleshooting
- **H2 Console nÃ£o abre** â†’ confira `spring.h2.console.enabled=true` e a URL JDBC acima.
- **JWT 401** â†’ refaÃ§a o login; copie **somente** o token (sem aspas) no Authorize.
- **Flyway falhou** â†’ apague a pasta `data/` (somente em dev) e rode novamente.
- **Porta 8080 ocupada** â†’ `server.port=8081` em `application-dev.properties`.

---

## ğŸ‘¨â€ğŸ’» Desenvolvedores
- **Thamires Ribeiro Cruz** â€” RM558128 Â· [github.com/ThamiresRC](https://github.com/ThamiresRC)
- **Adonay Rodrigues da Rocha** â€” RM558782 Â· [github.com/AdonayRocha](https://github.com/AdonayRocha)
- **Pedro Henrique Martins dos Reis** â€” RM555306 Â· [github.com/pxxmdr](https://github.com/pxxmdr)

---

## ğŸ“œ LicenÃ§a
Uso acadÃªmico/educacional.

---

## ğŸ™Œ CrÃ©ditos
Projeto desenvolvido por **Thamires Ribeiro** na disciplina **Java Advanced (Sprint 3)** â€“ FIAP. Agradecimentos ao professor e colegas pelo apoio nas revisÃµes e testes.

