<!DOCTYPE html>
<html lang="pt-br" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="https://www.thymeleaf.org/extras/spring-security">
<head th:replace="~{fragments/_head :: head('Locações • SafeYard')}">
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Locações • SafeYard</title>
</head>
<body class="bg-light">

<nav th:replace="~{fragments/_navbar :: navbar('locacoes')}"></nav>

<main class="container py-4">

    <h1 class="h4 mb-3">Locações</h1>

    <!-- alertas -->
    <div th:if="${error}" class="alert alert-danger" th:text="${error}">Erro</div>
    <div th:if="${msg}" class="alert alert-success" th:text="${msg}">Ok</div>

    <!-- AÇÃO ADMIN: Zerar locações ativas -->
    <form th:action="@{/locacoes/fechar-ativas}" method="post" class="mb-3" sec:authorize="hasRole('ADMIN')">
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
        <button class="btn btn-outline-danger"
                type="submit"
                onclick="return confirm('Encerrar TODAS as locações ativas agora? O histórico será mantido.');">
            Zerar locações ativas (manter histórico)
        </button>
    </form>

    <!-- filtros -->
    <form class="row gy-2 gx-3 align-items-end mb-3" th:action="@{/locacoes}" method="get">
        <div class="col-sm-3">
            <label class="form-label" for="clienteId">Cliente</label>
            <select id="clienteId" name="clienteId" class="form-select">
                <option value="">Todos</option>
                <option th:each="c : ${clientes}"
                        th:value="${c.id}"
                        th:text="${c.nome}"
                        th:selected="${clienteId} != null and ${clienteId} == ${c.id}">
                    Cliente
                </option>
            </select>
        </div>

        <div class="col-sm-3">
            <label class="form-label" for="motoId">Moto</label>
            <select id="motoId" name="motoId" class="form-select">
                <option value="">Todas</option>
                <option th:each="m : ${motos}"
                        th:value="${m.id}"
                        th:text="${m.modelo}"
                        th:selected="${motoId} != null and ${motoId} == ${m.id}">
                    Moto
                </option>
            </select>
        </div>

        <div class="col-sm-3">
            <label class="form-label" for="dataSaidaDe">Saída de</label>
            <input id="dataSaidaDe" type="date" name="dataSaidaDe" class="form-control"
                   th:value="${inicio != null ? #temporals.format(inicio, 'yyyy-MM-dd') : ''}"/>
        </div>

        <div class="col-sm-3">
            <label class="form-label" for="dataDevolucaoAte">Devolução até</label>
            <input id="dataDevolucaoAte" type="date" name="dataDevolucaoAte" class="form-control"
                   th:value="${fim != null ? #temporals.format(fim, 'yyyy-MM-dd') : ''}"/>
        </div>

        <div class="col-12">
            <button class="btn btn-primary">Filtrar</button>
        </div>
    </form>

    <!-- tabela -->
    <div class="table-responsive">
        <table class="table table-striped align-middle">
            <thead class="table-light">
            <tr>
                <th>ID</th>
                <th>Cliente</th>
                <th>Moto</th>
                <th>Data Saída</th>
                <th>Data Devolução</th>
                <th>Condição Entrega</th>
                <th>Condição Devolução</th>
                <th>QR Code</th>
                <th>Ações</th>
            </tr>
            </thead>
            <tbody>

            <tr th:each="l : ${locacoes}"
                th:with="cli=${clientesById[l.clienteId]},
                         mot=${motosById[l.motoId]}">

                <td th:text="${l.id}">1</td>
                <td th:text="${cli != null ? cli.nome : '—'}">—</td>
                <td th:text="${mot != null ? mot.modelo : '—'}">—</td>

                <td th:text="${l.dataSaida != null ? #temporals.format(l.dataSaida, 'dd/MM/yyyy') : '—'}">—</td>
                <td th:text="${l.dataDevolucao != null ? #temporals.format(l.dataDevolucao, 'dd/MM/yyyy') : '—'}">—</td>

                <td th:text="${l.condicaoEntrega != null ? l.condicaoEntrega : '—'}">—</td>
                <td th:text="${l.condicaoDevolucao != null ? l.condicaoDevolucao : '—'}">—</td>

                <td>
                    <a th:href="@{/locacoes/{id}/qrcode(id=${l.id})}" target="_blank" rel="noopener">Ver</a>
                    <span class="text-muted mx-1">|</span>
                    <a th:if="${l.qrCode != null and !#strings.isEmpty(l.qrCode) and
                              (#strings.startsWith(l.qrCode,'http://') or
                               #strings.startsWith(l.qrCode,'https://') or
                               #strings.startsWith(l.qrCode,'data:'))}"
                       th:href="${l.qrCode}" target="_blank" rel="noopener">Origem</a>
                    <span th:if="${l.qrCode == null || #strings.isEmpty(l.qrCode) ||
                                  (!#strings.startsWith(l.qrCode,'http://') and
                                   !#strings.startsWith(l.qrCode,'https://') and
                                   !#strings.startsWith(l.qrCode,'data:'))}"
                          class="text-muted">—</span>
                </td>

                <td>
                    <a th:href="@{/locacoes/{id}(id=${l.id})}">Ver</a>
                </td>
            </tr>

            <tr th:if="${#lists.isEmpty(locacoes)}">
                <td colspan="9" class="text-muted text-center py-4">Nenhuma locação encontrada.</td>
            </tr>

            </tbody>
        </table>
    </div>

</main>

<footer th:insert="~{fragments/_footer :: footer}"></footer>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
<script src="/js/csrf.js"></script>
</body>
</html>
